---
title: "<span style='color: coral ;font-family: Times New Roman, serif; font-size: 28pt; font-weight: bold; text-align: center;display: block;'>Cuadro depresivo vs: alcoholismo,<br> salario medio y horas de luz</span><br>"

author: "<span style='font-size: 20pt;'>Henar Ronda, Yasmina Álamo y Raúl Ortega</span>"
date: "`r format (Sys.time(),'%d %B %Y')`"
output: 
  html_document:
    toc: TRUE
    css: stt.css
  pdf_document:
      keep_text: TRUE
---
# __Introducción__

  El estudio que nos ocupa se trata de un análisis de la Salud Mental, más concretamente del nivel de cuadro depresivo mayor total por Comunidades Autónomas para ambos sexos. Para ello hemos querido estudiar tres posibles causas que podrían relacionarse como causa-efecto: el consumo de alcohol, el salario promedio y las horas de luz al año que disfrutan los habitantes de las respectivas comunidades. 
  Hemos estructurado el informe en tres partes principales donde compararemos la depresión con cada uno de estos factores, y finalmente una comparación global donde extraeremos las conclusiones.
  Cabe destacar que el estudio ha sido realizado a nivel de España.
  

## __Depresión__


### _Datos sobre la depresión_
  Para el análisis trabajaremos sobre el índice que indica el nivel de depresión
A continuación se mostrarán los datos del cuadro depresivo mayor por Comunidad Autónoma. 
Importamos la biblioteca correspondiente para poder leer el archivo csv: 

```{r, eval=TRUE, echo=TRUE}
library(readxl)
library(DT)
library(dplyr)
```
Importamos los datos a tratar y los mostramos como una tabla.
Los datos se refieren a una población de 15 años y más, y la medida l encontramos en porcentaje, es decir, la proporción de personas que padecen un cuadro depresivo mayor por cada 100 personas. 
Antes de ponernos a analizar, describiremos brevemente las características de esta prevalencia.
Algunas de las más importantes son:
- Fatiga y falta de energía
- Sentimientos de desesperanza, inutilidad u odio a si mismo
- Pérdida de interés en actividades que se disfrutaban
- Dificultad de concentración
- Dificultad para conciliar el sueño
- Cambio súbito en el apetito

```{r, eval=TRUE, echo=TRUE}
depresion <- read.csv("INPUT/DATA/depresion_cambiado.csv", 
    sep = ";", fileEncoding = "Latin1", header = TRUE, stringsAsFactors = FALSE)%>%
  select(Comunidades.y.Ciudades.Autónomas, Total)

depresion$Comunidades.y.Ciudades.Autónomas[depresion$Comunidades.y.Ciudades.Autónomas == ""] <- "Media Nacional"
datatable(depresion)
```


## __Alcoholismo__

### _Datos sobre el alcoholismo:_
  En primer lugar tenemos un conjunto de datos que estudian la cantidad de alcohol que se consume por Comunidad Autónoma. La medida total se encuentra en gramos de alcohol puro diario por personas que beben más de una vez al mes donde, por ejemplo, una cerveza con alcohol equivale a 10 g.

No es necesario importar la biblioteca que nos permitirá leer el archivo csv ya que ha sido importada anteriormente.

Importamos los datos mediante el siguiente código:

```{r, eval=TRUE, echo=TRUE}
library(dplyr)
alcohol <- read.csv("INPUT/DATA/ALCOHOL.csv", 
    sep = ";", fileEncoding = "Latin1", header = TRUE, stringsAsFactors = FALSE)%>%
  select(Comunidades.y.Ciudades.Autónomas, Total)
  
alcohol$Comunidades.y.Ciudades.Autónomas[alcohol$Comunidades.y.Ciudades.Autónomas == ""] <- "Media Nacional"
datatable(alcohol)
```

### _Comparación con la depresión_
  Para poder comparar los datos y sacar conclusiones, hemos de cruzar las tablas y obtener una gráfica que nos permita observar la relación existente entre ambos factores. Para ello realizaremos el siguiente código:
```{r, eval=TRUE, echo=TRUE}
comparacion<-inner_join(depresion, alcohol, by= "Comunidades.y.Ciudades.Autónomas")
tabla_final <- comparacion %>%
  select("Comunidades Autónomas"="Comunidades.y.Ciudades.Autónomas", "Prevalencia Depresión"=Total.x, "Consumo Alcohol"=Total.y)

datatable(tabla_final)
```  

  Tras hallar la tabla realizada a través de un join para visualizar de forma más clara los datos unidos por las comunidades autónomas, procedemos a representar visualmente dichos datos de forma que nos permita ver realmente la relación entre ambas variables.
  
  Para ello lo primero que hacemos es importar la librería que necesitamos para los gráficos.
  
```{r, eval=TRUE, echo=TRUE}
library(tidyverse)
library(ggplot2)
```

  A continuación, el código junto a los resultados:
```{r, eval=TRUE, echo=TRUE}
ggplot(tabla_final, aes(y = `Consumo Alcohol`, x = `Prevalencia Depresión`, fill = `Comunidades Autónomas`)) +
  geom_col(position = "dodge") + 
  labs(title = "Consumo de Alcohol vs Prevalencia de Depresión", y = "Consumo de Alcohol", x = "Prevalencia de Depresión") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_flip()

```

  Graficamos los mismos datos mediante un gráfico de puntos o dispersión para ver la R cuadrada

```{r, eval=TRUE, echo=TRUE}
# Graficar los mismos datos como un gráfico de puntos

ggplot(tabla_final, aes(y = `Consumo Alcohol`, x = `Prevalencia Depresión`, color = `Comunidades Autónomas`)) +
  geom_point(size = 3) +  # Utilizamos geom_point para gráfico de puntos
  labs(y = "Consumo de Alcohol", x = "Prevalencia de Depresión") +

  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip()

```
  

### <span style='background-color: lightgreen; padding: 3px;'>_Análisis breve_</span>  
  En base a los resultados obtenidos, podemos concluir que el alcohol no sería una razón de peso que afecte a la revalencia de depresión a nivel de cuadro depresivo mayor, puesto que: <br>
- En el primer gráfico, no vemos una relación clara entre ambas variables. Por ejemplo en la Comunidad de Andalucía la prevalencia de depresión es la segunda más alta y sin embargo el consumo de alcohol en base a la medición con la que se analiza es la más baja, con lo cual claramente no podemos afirmar que sea una relación directa. Se puede deber a otros factores que analizaremos a continuación <br>
- En el gráfico de dispersión se nos confirma que no sigue una línea más o menos recta y no tiene validez pues el R cuadrado no tiene el valor que esperaríamos para poder afirmar la relación

## __Salario__

### _Datos sobre el salario medio_
  Este factor que analizaremos tiene en cuenta el salario medio anual por individuo dependiendo de la Comunidad Autónoma en la que se encuentre. 

  Para poder trabajar datos en formato __JSON__ tenemos que importar primero esta biblioteca:
```{r,eval=TRUE, echo=TRUE}
library(jsonlite)
library(knitr)
```
  Ruta al archivo JSON
  
```{r,eval=TRUE, echo=TRUE}
ruta_archivo<-"INPUT/DATA/salarios.json"
```
  Datos salario
```{r,eval=TRUE, echo=TRUE}
salarios<-fromJSON(ruta_archivo)
tabla_salarios <- data.frame(Nombres = character(), Total = numeric())
a <- mapply(list, salarios$Nombre, salarios$Data, SIMPLIFY = FALSE)
for (i in a){
  if(grepl("decil", i[[1]]) & !grepl("Jornada", i[[1]])) {
    tabla_salarios <- rbind(tabla_salarios, data.frame(Nombres = i[[1]], Salario = i[[2]]$Valor))  
  }
}

tabla_salarios <- tabla_salarios %>%
  separate( Nombres, into = c("Tot", "Comunidades.y.Ciudades.Autónomas","base","decil", "Salario medio"), sep = "\\.")%>%
  select(Comunidades.y.Ciudades.Autónomas, Salario)

tabla_salarios$Comunidades.y.Ciudades.Autónomas[1] <- "Media Nacional"
datatable(tabla_salarios)
```


### _Comparación con la depresión_
```{r, eval=FALSE, echo=TRUE}
library(dplyr)
library(DT)
depresion <- 
  depresion %>%
  mutate(Factores= factor(Comunidades.y.Ciudades.Autónomas))

depresion$Factores
factor(tabla_salarios$Comunidades.y.Ciudades.Autónomas)
factores_comunes <- levels(depresion$Factores)


nuevo_salario<- 
  tabla_salarios%>%
  mutate(Comunidades.y.Ciudades.Autónomas = factor(Comunidades.y.Ciudades.Autónomas, levels=c("Media Nacional"="Media Nacional","Andalucía"="Andalucía","Aragón"="Aragón", "Asturias, Principado de"="Asturias (Principado de)","Balears, Illes"="Balears (Illes)","Canarias"="Canarias", "Cantabria" ="Cantabria","Castilla y León"="Castilla y León","Castilla - La Mancha"="Castilla-La Mancha","Cataluña"="Cataluña","Comunitat Valenciana"="Comunitat Valenciana","Extremadura"="Extremadura", "Galicia"="Galicia", "Madrid, Comunidad de"= "Madrid (Comunidad de)","Murcia, Región de"="Murcia (Región de)", "Navarra, Comunidad Foral de"= "Navarra (Comunidad Foral de)","País Vasco"="País Vasco", "Rioja, La"="Rioja (La)", "Ceuta"="Ceuta (Ciudad Autónoma de)","Melilla"="Melilla (Ciudad Autónoma de)")))
datatable(nuevo_salario)

datatable(comparacion_2)
tabla_final <- comparacion %>%
  select("Comunidades Autónomas"="Comunidades.y.Ciudades.Autónomas", "Prevalencia Depresión"=Total.x, "Salario"=Total.y)
datatable(tabla_final)

``` 
```{r, eval=TRUE, echo=TRUE}
combi<-merge(tabla_salarios, depresion, by="Comunidades.y.Ciudades.Autónomas", all=TRUE)
combi%>%
  select(Total.x,Total.y)
datatable(combi)
```


### <span style='background-color: lightgreen; padding: 3px;'>_Análisis breve_</span> 

## __Horas de luz__

### _Datos sobre horas de luz_
En este caso estudiaremos el número de horas de luz que disfruta cada provincia en España al año. Los datos los tenemos agrupados por provincias, por lo que hemos de cambiarlo a Comunidades Autónomas.
Esta información procede de una página web. Para poder trabajar con los datos usaremos la librería rvest. 
```{r,eval=TRUE, echo=TRUE}
 library(rvest)
 library(XML)
 library(xml2)
 library(tidyverse)
```
Leemos la página:
```{r,eval=TRUE, echo=TRUE}
 document <- read_html("https://facturadelaluz.com/solar/que-provincias-tienen-mas-horas-de-sol/")
```
Seleccionamos los datos con los que queremos trabajar, en este caso las tablas:
```{r,eval=TRUE, echo=TRUE}
html_products <- document %>% html_elements(".table-default")
html_products
```

Creamos un vector con los nombres de las comunidades autonomas: 
```{r}
com_autom <- c("ANDALUCÍA", 
"ARAGÓN", 
"ASTURIAS",
"CANTABRIA", 
"CATALUÑA", 
"CASTILLA Y LEÓN", 
"CASTILLA LA MANCHA",
"MADRID", 
"VALENCIA",
"EXTREMADURA",
"GALICIA",
"ISLAS BALEARES",
"ISLAS CANARIAS",
"RIOJA",
"MURCIA",
"NAVARRA",
"PAÍS VASCO")
```

Elaboramos un bucle para poder 
```{r}
for(i in seq_along(html_products)){ # Iteramos sobre los nodos de nuestro archivo xml 
    
    node_content <- xml_text(html_products[i]) # Extraemos la información de cada tabla 
  
    sinpunt <- gsub("\\.", "", node_content) # Eliminamos los puntos de los digitos
    es <- str_extract_all(sinpunt, "\\d+") # Extraemos unicamente los números
    num <- as.numeric(unlist(es)) # Pasamos de una string a numeric 
    datos_luz <- list(num[num > 1000])
    #cat(datos_luz,"\n")
    horasLuzMedia <- lapply(datos_luz,mean)
    ComAutom <- list(com_autom)
    horas_luz <- data.frame(ComunidadesAutonomas = com_autom, HorasDeLuzMedia = horasLuzMedi)
}
horas_luz
```
```{r}
# Crear una lista vacía para almacenar los vectores
lista_datos_luz <- list()

for(i in seq_along(html_products)){ # Iteramos sobre los nodos de nuestro archivo xml 
    
    node_content <- xml_text(html_products[i]) # Extraemos la información de cada tabla 
  
    sinpunt <- gsub("\\.", "", node_content) # Eliminamos los puntos de los digitos
    es <- str_extract_all(sinpunt, "\\d+") # Extraemos unicamente los números
    num <- as.numeric(unlist(es)) # Pasamos de una string a numeric 
    datos_luz <- num[num > 1000]
    
    # Añadir datos_luz a la lista
    lista_datos_luz[[i]] <- datos_luz
}
lista_datos_luz
horasLuzMedia <- lapply(datos_luz,mean)
horasLuzMedia
```







### _Comparación con la depresión_


### <span style='background-color: lightgreen; padding: 3px;'>_Análisis breve_</span> 

# __Conclusión__






